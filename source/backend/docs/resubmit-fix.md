# æŠ¥é”€å•é‡æ–°æäº¤åŠŸèƒ½ä¿®å¤æ–‡æ¡£

## é—®é¢˜æè¿°

åœ¨æŠ¥é”€å•é‡æ–°æäº¤åŠŸèƒ½ä¸­å‘ç°ä¸€ä¸ªå…³é”®bugï¼šå½“æŠ¥é”€å•ä¸­çš„æŸäº›è®°å½•è¢«è´¢åŠ¡é©³å›åï¼Œç”¨æˆ·é‡æ–°æäº¤æŠ¥é”€å•æ—¶ï¼Œè¢«é©³å›è®°å½•çš„çŠ¶æ€æ²¡æœ‰è¢«æ­£ç¡®é‡ç½®ï¼Œå¯¼è‡´ï¼š

1. è¢«é©³å›è®°å½•çš„ `approval_status` ä»ç„¶æ˜¯ `rejected`
2. `reject_reason` æ²¡æœ‰è¢«æ¸…ç©º
3. æŠ¥é”€å•çš„ `rejected_record_count` æ²¡æœ‰é‡ç½®ä¸º0
4. å®¡æ‰¹å†å²è®°å½•æ²¡æœ‰æ¸…ç†ï¼Œå¯èƒ½å¯¼è‡´çŠ¶æ€å†²çª

## æ ¹æœ¬åŸå› 

åŸä»£ç åœ¨ `submitForm` å‡½æ•°ä¸­çš„é€»è¾‘ç¼ºé™·ï¼š

```javascript
// åŸæœ‰é—®é¢˜ä»£ç 
if(!['draft','rejected'].includes(norm)){
  // å½“æŠ¥é”€å•çŠ¶æ€æ˜¯'å¾…è´¢åŠ¡å®¡æ ¸'æ—¶ï¼Œç›´æ¥è¿”å›ï¼Œä¸æ‰§è¡Œé‡ç½®é€»è¾‘
  if(['submitted','finance_approved','manager_approved'].includes(norm)){
    return { formId, status: form.status };
  }
  throw new Error('INVALID_STATE');
}
```

å½“æŠ¥é”€å•æ•´ä½“çŠ¶æ€æ˜¯"å¾…è´¢åŠ¡å®¡æ ¸"æ—¶ï¼Œå‡½æ•°ä¼šç›´æ¥è¿”å›ï¼Œä¸ä¼šæ£€æŸ¥æ˜¯å¦æœ‰è¢«é©³å›çš„è®°å½•éœ€è¦é‡ç½®ã€‚

## ä¿®å¤æ–¹æ¡ˆ

### 1. æ ¸å¿ƒä¿®å¤é€»è¾‘

åœ¨ `backend/src/services/formService.js` çš„ `submitForm` å‡½æ•°ä¸­æ·»åŠ è¢«é©³å›è®°å½•æ£€æŸ¥ï¼š

```javascript
// ğŸ”§ å…³é”®ä¿®å¤ï¼šæ£€æŸ¥æ˜¯å¦æœ‰è¢«é©³å›çš„è®°å½•ï¼Œä¸ä»…ä»…ä¾èµ–æŠ¥é”€å•æ•´ä½“çŠ¶æ€
const rejectedCount = db.prepare("SELECT COUNT(*) as count FROM reimbursements WHERE form_id = ? AND approval_status = 'rejected'").get(formId);
const hasRejectedRecords = rejectedCount && rejectedCount.count > 0;

if(!['draft','rejected'].includes(norm) && !hasRejectedRecords){
  // åªæœ‰åœ¨æ²¡æœ‰è¢«é©³å›è®°å½•çš„æƒ…å†µä¸‹æ‰ç›´æ¥è¿”å›
  if(['submitted','finance_approved','manager_approved'].includes(norm)){
    return { formId, status: form.status };
  }
  throw new Error('INVALID_STATE');
}
```

### 2. å®Œæ•´çš„é‡ç½®é€»è¾‘

å½“æ£€æµ‹åˆ°æœ‰è¢«é©³å›è®°å½•æ—¶ï¼Œæ‰§è¡Œå®Œæ•´çš„é‡ç½®ï¼š

```javascript
if (norm === 'rejected' || hasRejectedRecords) {
  try {
    // é‡ç½®æŠ¥é”€è®°å½•çš„å®¡æ‰¹çŠ¶æ€
    db.prepare("UPDATE reimbursements SET approval_status = 'pending', approver_id = NULL, approved_at = NULL, reject_reason = NULL WHERE form_id = ?")
      .run(formId);
    
    // æ¢å¤è®°å½•çŠ¶æ€
    db.prepare("UPDATE reimbursements SET status = 'å·²å½’é›†åˆ°æŠ¥é”€å•', form_status = 'å·²ç»‘å®š' WHERE form_id = ?")
      .run(formId);
    
    // é‡ç½®ç»Ÿè®¡å­—æ®µ
    db.prepare('UPDATE reimbursement_forms SET approved_record_count = 0, rejected_record_count = 0 WHERE id = ?')
      .run(formId);
    
    // æ¸…ç†å®¡æ‰¹å†å²è®°å½•
    db.prepare('DELETE FROM reimbursement_form_approval_logs WHERE form_id = ?')
      .run(formId);
  } catch(_) {}
}
```

## æµ‹è¯•éªŒè¯

### 1. é›†æˆæµ‹è¯•

åˆ›å»ºäº†å®Œæ•´çš„é›†æˆæµ‹è¯• `tests/integration/resubmit.integration.test.js`ï¼š

- åˆ›å»ºæµ‹è¯•æŠ¥é”€å•
- æ¨¡æ‹Ÿè´¢åŠ¡é©³å›
- æµ‹è¯•é‡æ–°æäº¤
- éªŒè¯çŠ¶æ€é‡ç½®

è¿è¡Œæµ‹è¯•ï¼š
```bash
npm run test:integration
```

### 2. ä»£ç è´¨é‡æ£€æŸ¥

åˆ›å»ºäº†ä»£ç æ£€æŸ¥è„šæœ¬ `scripts/check-resubmit-logic.js`ï¼š

- æ£€æŸ¥å…³é”®é€»è¾‘æ˜¯å¦å­˜åœ¨
- éªŒè¯ä¿®å¤ä»£ç å®Œæ•´æ€§
- æä¾›æ”¹è¿›å»ºè®®

è¿è¡Œæ£€æŸ¥ï¼š
```bash
npm run check:resubmit
```

## é˜²æ­¢å›é€€çš„æªæ–½

### 1. è‡ªåŠ¨åŒ–æµ‹è¯•

- **é›†æˆæµ‹è¯•**ï¼šæ¯æ¬¡ä»£ç å˜æ›´éƒ½ä¼šè¿è¡Œå®Œæ•´çš„ä¸šåŠ¡æµç¨‹æµ‹è¯•
- **å•å…ƒæµ‹è¯•**ï¼šé’ˆå¯¹æ ¸å¿ƒé€»è¾‘çš„ç»†ç²’åº¦æµ‹è¯•
- **ä»£ç æ£€æŸ¥**ï¼šé™æ€åˆ†æç¡®ä¿å…³é”®é€»è¾‘å­˜åœ¨

### 2. CI/CDæµæ°´çº¿

åœ¨ `.github/workflows/test.yml` ä¸­é…ç½®ï¼š

- æ¯æ¬¡pushå’ŒPRéƒ½ä¼šè§¦å‘æµ‹è¯•
- å¤šNode.jsç‰ˆæœ¬å…¼å®¹æ€§æµ‹è¯•
- é›†æˆæµ‹è¯•éªŒè¯å®Œæ•´ä¸šåŠ¡æµç¨‹

### 3. ä»£ç å®¡æŸ¥æ£€æŸ¥ç‚¹

åœ¨ä»£ç å®¡æŸ¥æ—¶éœ€è¦ç‰¹åˆ«å…³æ³¨ï¼š

- `submitForm` å‡½æ•°çš„æ¡ä»¶åˆ¤æ–­é€»è¾‘
- è¢«é©³å›è®°å½•çš„æ£€æŸ¥å’Œé‡ç½®é€»è¾‘
- å®¡æ‰¹çŠ¶æ€ç›¸å…³çš„æ•°æ®åº“æ“ä½œ

### 4. ç›‘æ§å’Œå‘Šè­¦

å»ºè®®åœ¨ç”Ÿäº§ç¯å¢ƒä¸­æ·»åŠ ç›‘æ§ï¼š

- ç›‘æ§é‡æ–°æäº¤åè¢«é©³å›è®°å½•æ•°é‡æ˜¯å¦ä¸º0
- ç›‘æ§å®¡æ‰¹çŠ¶æ€å¼‚å¸¸çš„æŠ¥é”€å•
- ç”¨æˆ·åé¦ˆçš„çŠ¶æ€ä¸ä¸€è‡´é—®é¢˜

## ä½¿ç”¨æ–¹æ³•

### å¼€å‘ç¯å¢ƒæµ‹è¯•

```bash
# è¿è¡Œæ‰€æœ‰æµ‹è¯•
npm run test:all

# åªè¿è¡Œé‡æ–°æäº¤ç›¸å…³æµ‹è¯•
npm run test:integration

# æ£€æŸ¥ä»£ç é€»è¾‘
npm run check:resubmit

# æäº¤å‰æ£€æŸ¥
npm run precommit
```

### ç”Ÿäº§ç¯å¢ƒéªŒè¯

1. åˆ›å»ºæµ‹è¯•æŠ¥é”€å•
2. è®©è´¢åŠ¡é©³å›æŸäº›è®°å½•
3. é‡æ–°æäº¤æŠ¥é”€å•
4. éªŒè¯è¢«é©³å›è®°å½•çŠ¶æ€æ˜¯å¦é‡ç½®ä¸º `pending`
5. éªŒè¯é©³å›åŸå› æ˜¯å¦æ¸…ç©º
6. éªŒè¯æŠ¥é”€å•ç»Ÿè®¡æ•°æ®æ˜¯å¦æ­£ç¡®

## ç›¸å…³æ–‡ä»¶

- `src/services/formService.js` - æ ¸å¿ƒä¿®å¤é€»è¾‘
- `tests/integration/resubmit.integration.test.js` - é›†æˆæµ‹è¯•
- `scripts/check-resubmit-logic.js` - ä»£ç æ£€æŸ¥è„šæœ¬
- `.github/workflows/test.yml` - CI/CDé…ç½®

## æ€»ç»“

è¿™ä¸ªä¿®å¤ç¡®ä¿äº†æŠ¥é”€å•é‡æ–°æäº¤åŠŸèƒ½çš„æ­£ç¡®æ€§ï¼Œé€šè¿‡å¤šå±‚æ¬¡çš„æµ‹è¯•å’Œæ£€æŸ¥æœºåˆ¶ï¼Œæœ‰æ•ˆé˜²æ­¢äº†åŒç±»é—®é¢˜çš„å†æ¬¡å‘ç”Ÿã€‚å…³é”®åœ¨äºï¼š

1. **æ­£ç¡®çš„ä¸šåŠ¡é€»è¾‘**ï¼šä¸ä»…æ£€æŸ¥æŠ¥é”€å•æ•´ä½“çŠ¶æ€ï¼Œè¿˜è¦æ£€æŸ¥è®°å½•çº§åˆ«çš„çŠ¶æ€
2. **å®Œæ•´çš„çŠ¶æ€é‡ç½®**ï¼šæ¸…ç†æ‰€æœ‰ç›¸å…³çš„å®¡æ‰¹ç—•è¿¹
3. **å…¨é¢çš„æµ‹è¯•è¦†ç›–**ï¼šä»å•å…ƒæµ‹è¯•åˆ°é›†æˆæµ‹è¯•çš„å®Œæ•´éªŒè¯
4. **è‡ªåŠ¨åŒ–çš„è´¨é‡ä¿è¯**ï¼šé€šè¿‡CI/CDå’Œä»£ç æ£€æŸ¥é˜²æ­¢å›é€€
