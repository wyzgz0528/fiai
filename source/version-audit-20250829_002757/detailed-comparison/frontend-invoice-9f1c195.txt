  { value: 'å…¶ä»–', label: 'å…¶ä»–' },
];

function ReimbursementForm() {
  const { id } = useParams();
  const navigate = useNavigate();
  const [form] = Form.useForm();
  
  // æ˜ç»†æ•°æ®çŠ¶æ€
  const [items, setItems] = useState([
    { key: Date.now(), amount: '', purpose: '', type: '', remark: '', uploaded: [], invoice_number: '' }
  ]);
  const [loading, setLoading] = useState(false);
  const [isEdit, setIsEdit] = useState(false);
  const [dynamicTypes, setDynamicTypes] = useState(fallbackTypeOptions);
  const [formStatus, setFormStatus] = useState(''); // æ–°å¢ï¼šå½“å‰æŠ¥é”€å•çŠ¶æ€
  const [ocrLoading, setOcrLoading] = useState({}); // OCRè¯†åˆ«åŠ è½½çŠ¶æ€

  // é¢„è§ˆç›¸å…³çŠ¶æ€
  const [previewVisible, setPreviewVisible] = useState(false);
  const [previewFile, setPreviewFile] = useState(null);
--
            return {
              key: `exist-${r.id}`,
              id: r.id,
              amount: r.amount,
              purpose: r.purpose,
              type: r.type,
              remark: r.remark,
              uploaded: [], // æ–°å¢é™„ä»¶åˆ—è¡¨ï¼ˆä»…æ–°å¢çš„ä¸´æ—¶é™„ä»¶ï¼‰
              existingVouchers: recordVouchers, // è¯¥è®°å½•å…³è”çš„å‡­è¯åˆ—è¡¨
              existingVoucherCount: recordVouchers.length,
              invoice_number: r.invoice_number || '', // å‘ç¥¨å·
              invoice_date: r.invoice_date || '', // å‘ç¥¨æ—¥æœŸ
              buyer_name: r.buyer_name || '', // è´­ä¹°æ–¹
              service_name: r.service_name || '' // æœåŠ¡åç§°
            };
          }));
            if (mapped.length) setItems(mapped);
        } catch (e) {
          message.error(e?.response?.data?.msg || 'åŠ è½½æŠ¥é”€å•å¤±è´¥');
        }
      })();
    }
--

  // æ·»åŠ æ˜ç»†è¡Œ
  const handleAddItem = () => {
    const newItem = {
      key: Date.now(),
      amount: '',
      purpose: '',
      type: '',
      remark: '',
      uploaded: [],
      invoice_number: '',
      invoice_date: '',
      buyer_name: '',
      service_name: ''
    };
    setItems(prev => [...prev, newItem]);
  };

  // åˆ é™¤æ˜ç»†è¡Œ
  const handleRemoveItem = (key) => {
    if (items.length === 1) {
      message.warning('è‡³å°‘ä¿ç•™ä¸€æ¡æ˜ç»†è®°å½•');
--
    return alphanumeric.slice(-8);
  };

  // å‘ç¥¨å·å˜æ›´å¤„ç†
  const handleInvoiceNumberChange = async (key, value) => {
    // å¤„ç†å‘ç¥¨å·ï¼Œåªä¿ç•™å8ä½æ•°å­—
    const processedValue = processInvoiceNumber(value);

    // æ›´æ–°å‘ç¥¨å·
    setItems(prev => prev.map(item =>
      item.key === key ? { ...item, invoice_number: processedValue } : item
    ));

    // å¦‚æœå‘ç¥¨å·ä¸ä¸ºç©ºï¼Œè¿›è¡Œå®æ—¶æŸ¥é‡éªŒè¯
    if (processedValue && processedValue.trim()) {
      try {
        const response = await api.get(`/api/reimbursement/check-duplicate?invoice_number=${encodeURIComponent(processedValue.trim())}`);
        if (response.data.isDuplicate) {
          message.warning(`å‘ç¥¨å· "${processedValue}" å·²å­˜åœ¨ï¼Œè¯·æ£€æŸ¥æ˜¯å¦é‡å¤å½•å…¥`);
        }
      } catch (error) {
        console.error('å‘ç¥¨å·æŸ¥é‡å¤±è´¥:', error);
        // ä¸é˜»æ–­ç”¨æˆ·è¾“å…¥ï¼Œä»…åœ¨æ§åˆ¶å°è®°å½•é”™è¯¯
      }
    }
  };

--
        console.log('å¤šå­—æ®µOCRè¯†åˆ«å“åº”:', result);

        // è·å–OCRæ•°æ®ï¼ˆå¯èƒ½åœ¨result.dataä¸­ï¼‰
        const ocrData = result.data || result;

        // æ•°æ®æ¸…ç†å‡½æ•°
        const cleanOCRValue = (value, type = 'text') => {
          if (!value) return value;
          let cleaned = String(value).trim();

          if (type === 'invoice_number') {
            // æ¸…ç†å‘ç¥¨å·ï¼šç§»é™¤å¼€å¤´çš„å†’å·ã€ç©ºæ ¼ç­‰ç‰¹æ®Šå­—ç¬¦
            cleaned = cleaned.replace(/^[:ï¼š\s]+/, '');
            // ç§»é™¤ç»“å°¾çš„ç‰¹æ®Šå­—ç¬¦
            cleaned = cleaned.replace(/[:ï¼š\s]+$/, '');
          } else if (type === 'amount') {
            // æ¸…ç†é‡‘é¢ï¼šç§»é™¤éæ•°å­—å­—ç¬¦ï¼ˆä¿ç•™å°æ•°ç‚¹ï¼‰
            cleaned = cleaned.replace(/[^\d.]/g, '');
            // è½¬æ¢ä¸ºæ•°å­—
            const num = parseFloat(cleaned);
            return isNaN(num) ? value : num;
          } else if (type === 'date') {
            // æ¸…ç†æ—¥æœŸï¼šæ ‡å‡†åŒ–æ ¼å¼
            cleaned = cleaned.replace(/[å¹´æœˆ]/g, '-').replace(/[æ—¥]/g, '');
          }

          return cleaned;
        };

        if (ocrData.invoice_number || ocrData.amount || ocrData.invoice_date) {
          // æ›´æ–°è¡¨å•å­—æ®µ
          const updates = {};

          // å‘ç¥¨å·ï¼ˆæ¸…ç†å¤šä½™å­—ç¬¦ï¼‰
          if (ocrData.invoice_number?.value) {
            const cleanedInvoiceNumber = cleanOCRValue(ocrData.invoice_number.value, 'invoice_number');
            updates.invoice_number = cleanedInvoiceNumber;
            await handleInvoiceNumberChange(itemKey, cleanedInvoiceNumber);
          }

          // é‡‘é¢ï¼ˆæ¸…ç†å¹¶è½¬æ¢ä¸ºæ•°å­—ï¼‰
          if (ocrData.amount?.value) {
            const cleanedAmount = cleanOCRValue(ocrData.amount.value, 'amount');
            updates.amount = cleanedAmount;
          }

          // ç”¨é€”å­—æ®µä¿æŒæ‰‹åŠ¨å¡«å†™ï¼Œä¸è‡ªåŠ¨å¡«å……

          // å‘ç¥¨æ—¥æœŸï¼ˆæ¸…ç†æ ¼å¼ï¼‰
          if (ocrData.invoice_date?.value) {
            const cleanedDate = cleanOCRValue(ocrData.invoice_date.value, 'date');
            updates.invoice_date = cleanedDate;
          }

          // è´­ä¹°æ–¹åç§°
          if (ocrData.buyer_name?.value) {
            const cleanedBuyerName = cleanOCRValue(ocrData.buyer_name.value);
            updates.buyer_name = cleanedBuyerName;
          }

          // æœåŠ¡åç§°
          if (ocrData.service_name?.value) {
--
                               (!isEdit && Object.keys(updates).length > 0); // æ–°å»ºæ¨¡å¼ä½†æœ‰è¯†åˆ«ç»“æœ

          if (shouldSaveOCR && Object.keys(updates).length > 0) {
            // å¦‚æœæ˜¯ç¼–è¾‘æ¨¡å¼ä¸”æœ‰IDï¼Œç«‹å³ä¿å­˜
            if (isEdit && item.id) {
              try {
                console.log('ç«‹å³ä¿å­˜OCRç»“æœåˆ°æ•°æ®åº“ï¼ŒæŠ¥é”€è®°å½•ID:', item.id);
                await api.post('/api/ocr/save-invoice-info', {
                  reimbursementId: item.id,
                  ocrResult: {
                    invoice_number: ocrData.invoice_number,
                    amount: ocrData.amount,
                    invoice_date: ocrData.invoice_date,
                    buyer_name: ocrData.buyer_name,
                    service_name: ocrData.service_name,
                    overall_confidence: ocrData.overall_confidence || 0.8
                  },
                  mode: 'auto_recognition'
                });
                console.log('OCRç»“æœå·²ç«‹å³ä¿å­˜åˆ°æ•°æ®åº“');
              } catch (saveError) {
                console.error('ç«‹å³ä¿å­˜OCRç»“æœå¤±è´¥:', saveError);
              }
            } else {
              // æ–°å»ºæ¨¡å¼ï¼šå­˜å‚¨OCRç»“æœï¼Œç­‰å¾…æŠ¥é”€å•ä¿å­˜åå†ä¿å­˜åˆ°æ•°æ®åº“
              console.log('æ–°å»ºæ¨¡å¼ï¼šå­˜å‚¨OCRç»“æœå¾…åç»­ä¿å­˜', {
                itemKey: itemKey,
                ocrData: {
                  invoice_number: ocrData.invoice_number?.value,
                  amount: ocrData.amount?.value,
                  invoice_date: ocrData.invoice_date?.value,
                  buyer_name: ocrData.buyer_name?.value,
                  service_name: ocrData.service_name?.value
                }
              });

              // å°†OCRç»“æœå­˜å‚¨åˆ°itemä¸­ï¼Œç­‰å¾…æŠ¥é”€å•ä¿å­˜åå¤„ç†
              setItems(prev => prev.map(prevItem =>
                prevItem.key === itemKey
                  ? {
                      ...prevItem,
                      pendingOcrResult: {
                        invoice_number: ocrData.invoice_number,
                        amount: ocrData.amount,
                        invoice_date: ocrData.invoice_date,
                        buyer_name: ocrData.buyer_name,
                        service_name: ocrData.service_name,
                        overall_confidence: ocrData.overall_confidence || 0.8
                      }
                    }
                  : prevItem
              ));
            }
          }

          // æ˜¾ç¤ºè¯†åˆ«ç»“æœ
          const recognizedFields = [];
          if (ocrData.invoice_number?.value) recognizedFields.push(`å‘ç¥¨å·: ${ocrData.invoice_number.value}`);
          if (ocrData.amount?.value) recognizedFields.push(`é‡‘é¢: Â¥${ocrData.amount.value}`);
          if (ocrData.invoice_date?.value) recognizedFields.push(`æ—¥æœŸ: ${ocrData.invoice_date.value}`);
          if (ocrData.buyer_name?.value) recognizedFields.push(`è´­ä¹°æ–¹: ${ocrData.buyer_name.value}`);
          if (ocrData.service_name?.value) recognizedFields.push(`æœåŠ¡: ${ocrData.service_name.value}`);

          message.success(`${opts.auto ? 'è‡ªåŠ¨' : ''}è¯†åˆ«æˆåŠŸï¼${recognizedFields.join(', ')}`);
        } else {
          if (!opts.auto) message.warning('æœªèƒ½è¯†åˆ«åˆ°å‘ç¥¨ä¿¡æ¯ï¼Œè¯·æ‰‹åŠ¨è¾“å…¥');
        }
      } else {
        console.log('æ–‡ä»¶ç¼ºå°‘temp_id:', firstFile);
        message.error('æ–‡ä»¶æ ¼å¼ä¸æ”¯æŒOCRè¯†åˆ«');
--
    }

    setLoading(true);
    try {
      const details = items.map(item => ({
        id: item.id, // ç¼–è¾‘æ—¶å¯ç”¨
        amount: item.amount,
        purpose: item.purpose,
        type: item.type,
        remark: item.remark,
        invoice_number: item.invoice_number, // å‘ç¥¨å·
        // ğŸ”§ ä¿®å¤ï¼šåŒ…å«æ‰€æœ‰å‘ç¥¨æ‰©å±•å­—æ®µ
        invoice_date: item.invoice_date, // å‘ç¥¨æ—¥æœŸ
        buyer_name: item.buyer_name, // è´­ä¹°æ–¹
        service_name: item.service_name, // æœåŠ¡åç§°
        attachments: item.uploaded || [], // æ–°å¢çš„ä¸´æ—¶é™„ä»¶
        existingVouchers: item.existingVouchers || [] // ç°æœ‰å‡­è¯ï¼ˆç¼–è¾‘æ—¶ä¿ç•™ï¼‰
      }));

      let response;
      if (isEdit) {
        response = await api.put(`/api/reimbursement/reimbursement-forms/${id}`,
          { items: details, status }
--
              </Row>

              <Row gutter={16}>
                {/* ç¬¬äºŒè¡Œï¼šå‘ç¥¨ä¿¡æ¯ */}
                <Col span={6}>
                  <div style={{ marginBottom: 16 }}>
                    <label style={{ display: 'block', marginBottom: 4, fontWeight: 500 }}>
                      å‘ç¥¨å·
                    </label>
                    <Input
                      value={item.invoice_number}
                      onChange={(e) => handleInvoiceNumberChange(item.key, e.target.value)}
                      placeholder="ä»…å¡«å†™å8ä½æ•°å­—æˆ–å­—æ¯"
                      maxLength={100}
                    />
                  </div>
                </Col>
                <Col span={6}>
                  <div style={{ marginBottom: 16 }}>
                    <label style={{ display: 'block', marginBottom: 4, fontWeight: 500 }}>å‘ç¥¨æ—¥æœŸ</label>
                    <Input
                      value={item.invoice_date}
                      onChange={(e) => handleItemChange(item.key, 'invoice_date', e.target.value)}
                      placeholder="å‘ç¥¨æ—¥æœŸ"
                      maxLength={50}
                    />
                  </div>
                </Col>
                <Col span={6}>
                  <div style={{ marginBottom: 16 }}>
                    <label style={{ display: 'block', marginBottom: 4, fontWeight: 500 }}>è´­ä¹°æ–¹</label>
                    <Input
                      value={item.buyer_name}
